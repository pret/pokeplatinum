.PHONY: all release debug check rom data target format clean distclean purge update setup_release setup_debug configure meson

MESON_VER := 1.7.0
MESON_DIR := subprojects/meson-$(MESON_VER)
MESON_SUB := $(MESON_DIR)/meson.py

MESON ?= $(MESON_SUB)
NINJA ?= ninja
WINELOADER ?= wine
GIT ?= git

BUILD ?= build
ROOT_INI := $(BUILD)/root.ini
DOT_MWCONFIG := $(BUILD)/.mwconfig

TOOLS := tools
WRAP := $(TOOLS)/cw
WRAP_BUILD := $(WRAP)/build
MWRAP := $(WRAP)/mwrap

UNAME_R := $(shell uname -r)
UNAME_S := $(shell uname -s)
CWD := $(shell pwd)

ifneq (,$(findstring Microsoft,$(UNAME_R)))
ifneq (,$(filter /mnt/%,$(CWD)))
WSL_ACCESSING_WINDOWS := 0
else
WSL_ACCESSING_WINDOWS := 1
endif
else
WSL_ACCESSING_WINDOWS := 1
endif

WRAP_CONFIG := 0
ifneq (,$(findstring Linux,$(UNAME_S)))
ifeq (0,$(WSL_ACCESSING_WINDOWS))
NATIVE := native.ini
CROSS := cross_unix.ini
else
NATIVE := native_unix.ini
CROSS := cross_unix.ini
endif
else
ifneq (,$(findstring Darwin,$(UNAME_S)))
NATIVE := native_macos.ini
CROSS := cross_unix.ini
else
ifneq (,$(findstring BSD, $(UNAME_S)))
NATIVE := native_unix.ini 
CROSS := cross_unix.ini
else
NATIVE := native.ini
CROSS := cross.ini
endif
endif
endif

export NINJA_STATUS := [%p %f/%t] 

all: release check

.NOTPARALLEL: release
release: setup_release rom

.NOTPARALLEL: debug
debug: setup_debug rom
	$(NINJA) -C $(BUILD) debug.nef overlay.map

check: rom
	$(MESON) test -C $(BUILD)

.NOTPARALLEL: rom
# We use a two-stage pipeline to absolve what appears to be a bug in Ninja
# where generated headers that are listed as order-only dependencies are not
# respected by the depfiles generated by compiling source code. To that end, we
# generate data-targets first (archives and generated headers), then proceed
# with compiling the ROM code.
rom: $(BUILD)/build.ninja data
	$(NINJA) -C $(BUILD) pokeplatinum.us.nds

data: $(BUILD)/build.ninja
	$(NINJA) -C $(BUILD) data

target: $(BUILD)/build.ninja
	$(NINJA) -C $(BUILD) $(MESON_TARGET)

format: $(BUILD)/build.ninja
	$(NINJA) -C $(BUILD) clang-format

clean: $(BUILD)/build.ninja
	$(MESON) compile -C $(BUILD) --clean

distclean:
	rm -rf $(BUILD) $(MWRAP)

purge: distclean
ifeq ($(MESON),$(MESON_SUB))
	! test -f $(MESON) || $(MESON) subprojects purge --confirm
	rm -rf $(dir $(MESON_SUB))
else
	$(MESON) subprojects purge --confirm
endif

update: meson
	$(MESON) subprojects update

setup_release: $(BUILD)/build.ninja
	$(MESON) configure build -Dgdb_debugging=false

setup_debug: $(BUILD)/build.ninja
	$(MESON) configure build -Dgdb_debugging=true

configure: $(BUILD)/build.ninja

$(BUILD)/build.ninja: $(ROOT_INI) $(DOT_MWCONFIG) | $(BUILD) meson
	MWCONFIG=$(abspath $(DOT_MWCONFIG)) $(MESON) setup \
	         --wrap-mode=nopromote \
	         --native-file=meson/$(NATIVE) \
	         --native-file=$(ROOT_INI) \
	         --cross-file=meson/$(CROSS) \
	         --cross-file=$(ROOT_INI) \
	         -- $(BUILD)

$(ROOT_INI): | $(BUILD)
	echo "[constants]" > $@
	echo "root = '$$PWD'" >> $@

$(DOT_MWCONFIG): $(MWRAP) | $(BUILD)
ifneq (,$(filter native_%.ini,$(NATIVE)))
	WINE="$$(command -v $(WINELOADER))"; \
	BUILD="$(BUILD)"; \
	MWCONFIG=$(abspath $(DOT_MWCONFIG)) $(MWRAP) -conf \
	         -wine "$$WINE" \
	         -path_unx "$$PWD" \
	         -path_win "$$("$$WINE" winepath -w "$$PWD")" \
	         -path_build_unx "$$BUILD" \
	         -path_build_win "$$("$$WINE" winepath -w "$$BUILD")"
else ifeq (0,$(WSL_ACCESSING_WINDOWS))
	BUILD="$(BUILD)"; \
	MWCONFIG=$(abspath $(DOT_MWCONFIG)) $(MWRAP) -conf \
	         -path_unx "$$PWD" \
	         -path_win "$$(wslpath -w "$$PWD")" \
	         -path_build_unx "$$BUILD" \
	         -path_build_win "$$(wslpath -w "$$PWD")"
else
	touch $(DOT_MWCONFIG)
endif

$(BUILD):
	mkdir -p -- $(BUILD)

$(MWRAP): | meson
	rm -rf $(MWRAP) $(WRAP_BUILD)
	$(MESON) setup $(WRAP_BUILD) $(WRAP)
	$(MESON) compile -C $(WRAP_BUILD)
	install -m755 $(WRAP_BUILD)/$(@F) $@
	rm -rf $(WRAP_BUILD)

meson: ;
ifeq ($(MESON),$(MESON_SUB))
meson: $(MESON_SUB)
endif

$(MESON_SUB):
	$(GIT) clone --depth=1 -b $(MESON_VER) https://github.com/mesonbuild/meson $(@D)
